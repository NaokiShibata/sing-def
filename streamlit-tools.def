Bootstrap: docker
From: python:3.11-slim-bookworm

%labels
  Author "Your Name <your.email@example.com>"
  Version "0.0.1"
  Description "Lightweight streamlit container Python 3.11 slim"

%environment
  PATH=/opt/venv/bin:/opt/duckdb:$PATH
  export CC=gcc
  export CXX=g++
  # uv setting
  export UV_NO_PROGRESS=1
  export UV_LINK_MODE=copy
  # Qt setting
  # export QT_QPA_PLATFORM=offscreen
  export QTWEBENGINE_DISABLE_SANDBOX=1
  export QT_QPA_PLATFORMTHEME=generic
  export NO_AT_BRIDGE=1
  export XDG_RUNTIME_DIR=/tmp/xdg


%post
  set -eux
  export DEBIAN_FRONTEND=noninteractive

  apt-get update

  apt-get install -y --no-install-recommends \
      ca-certificates curl wget unzip git \
      build-essential clang \
      patchelf \
      libgl1 libegl1 libopengl0 \
      libxkbcommon0 libxkbcommon-x11-0 \
      libxcb1 libxcb-render0 libxcb-shm0 libxcb-icccm4 libxcb-image0 \
      libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-shape0 \
      libxcb-xfixes0 libxcb-xinerama0 libxcb-xkb1 libxcb-cursor0 \
      libfontconfig1 libfreetype6 fonts-dejavu-core \
      xvfb \
      build-essential \
      libglib2.0-dev libopencv-dev \
      clang \
      wget \
      unzip \
      patchelf \
      ca-certificates \
      git \
      curl
  rm -rf /var/lib/apt/lists/*

  # DuckDB CLI バイナリを配置
  mkdir -p /opt/duckdb
  wget -q https://github.com/duckdb/duckdb/releases/download/v1.1.1/duckdb_cli-linux-amd64.zip -O /tmp/duckdb_cli.zip
  unzip /tmp/duckdb_cli.zip -d /opt/duckdb
  chmod +x /opt/duckdb/duckdb
  rm -f /tmp/duckdb_cli.zip

  # Install uv
  curl -LsSf https://astral.sh/uv/install.sh | sh
  ln -sf /root/.local/bin/uv /usr/local/bin/uv
  uv --version
  export UV_LINK_MODE=copy

  # Create venv
  uv venv /opt/venv --python 3.11
  . /opt/venv/bin/activate
  uv pip install --no-cache-dir --upgrade pip

  uv pip install --no-cache-dir \
    streamlit==1.49.0 \
    duckdb>=1.1.0 \
    pywebview>=5.2 \
    pyarrow>=17.0 \
    pandas>=2.2 \
    numpy==1.24.4 \
    pyyaml>=6.0 \
    streamlit-aggrid>=1.1.8 \
    Altair>=5.5.0 \
    pydantic>=2.11 \
    threadpoolctl>=3.6.0 \
    SciPy>=1.16.2 \
    plotly>=6.3.0 \
    scikit-bio>=0.7.0 \
    matplotlib>=3.10.6 \
    adjustText>=1.3.0 \
    seaborn >=0.13.2 \
    streamlit-option-menu>=0.4.0 \
    plot_phylo>=1.0.1

  # remove cache
  rm -rf /root/.cache/pip || true
  rm -rf /root/.cache/uv  || true

%runscript
  exec "$@"

%help
  streamlit container
